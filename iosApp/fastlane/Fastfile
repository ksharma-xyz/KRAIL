# Fastfile for KRAIL iOS App

default_platform(:ios)

# Project path constant (relative to iosApp/ directory)
PROJECT_PATH = "iosApp.xcodeproj"

platform :ios do
  desc "Build iOS App for Release"
  lane :build_release do
    # Defensive logging - verify project path
    UI.message("üìç Fastlane running from: #{Dir.pwd}")
    UI.message("üìÇ Project exists: #{File.exist?(PROJECT_PATH)}")

    setup_ci if ENV['CI']

    # Use default Xcode on CI (already points to latest stable)
    if ENV['CI']
      xcode_select("/Applications/Xcode.app")
    end

    # Configure App Store Connect API (recommended approach)
    if ENV["APPSTORE_KEY_ID"] && ENV["APPSTORE_ISSUER_ID"] && ENV["APP_STORE_CONNECT_API_KEY_PATH"]
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
        in_house: false
      )
    end

    # Log Fastlane environment (safe for CI logs)
    UI.message("üß™ Fastlane Environment")
    sh("fastlane env")

    # Log app version and build number (CRITICAL for TestFlight)
    UI.message("üì¶ App Version Info")
    sh("xcodebuild -showBuildSettings -project #{PROJECT_PATH} -scheme iosApp | grep -E 'MARKETING_VERSION|CURRENT_PROJECT_VERSION'")

    # Increment build number automatically
    if ENV['CI']
      increment_build_number(
        xcodeproj: PROJECT_PATH
      )
      # Log version after increment
      UI.message("üì¶ App Version Info (after increment)")
      sh("xcodebuild -showBuildSettings -project #{PROJECT_PATH} -scheme iosApp | grep -E 'MARKETING_VERSION|CURRENT_PROJECT_VERSION'")
    end

    # Log code signing resolution (what Xcode actually sees)
    UI.message("üîê Code Signing Resolution")
    sh("xcodebuild -project #{PROJECT_PATH} -scheme iosApp -showBuildSettings | grep -E 'CODE_SIGN|PROVISIONING|DEVELOPMENT_TEAM'")

    # Build the app
    build_app(
      scheme: "iosApp",
      project: PROJECT_PATH,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "build",
      output_name: "iosApp.ipa",
      clean: true,
      skip_build_archive: false,
      disable_package_automatic_updates: true,
      buildlog_path: "build/logs",
      suppress_xcode_output: false,
      codesigning_identity: "Apple Distribution",
      export_options: {
        method: "app-store"
      }
    )

    # Log IPA checksum for verification
    UI.message("üìÑ IPA checksum")
    sh("shasum -a 256 build/iosApp.ipa")
  end

  desc "Upload to TestFlight"
  lane :upload_testflight do
    # Configure API key if not already set
    if ENV["APPSTORE_KEY_ID"] && ENV["APPSTORE_ISSUER_ID"] && ENV["APP_STORE_CONNECT_API_KEY_PATH"]
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
        in_house: false
      )
    end

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      wait_for_uploaded_build: true,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false
    )
  end

  desc "Build and Upload to TestFlight"
  lane :release do
    build_release
    upload_testflight
  end
end

