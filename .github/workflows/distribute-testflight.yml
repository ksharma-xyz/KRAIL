name: Distribute TestFlight

on:
  workflow_call:
    inputs:
      artifact-name:
        required: true
        type: string
      notify-testers:
        required: false
        type: boolean
        default: false

jobs:
  distribute:
    runs-on: macos-15
    timeout-minutes: 60
    environment: Firebase
    steps:
      - uses: actions/checkout@v6

      - name: Setup environment variables
        run: |
          echo "IOS_NSW_TRANSPORT_API_KEY=${{ secrets.IOS_NSW_TRANSPORT_API_KEY }}" >> $GITHUB_ENV
          echo "ANDROID_NSW_TRANSPORT_API_KEY=${{ secrets.ANDROID_NSW_TRANSPORT_API_KEY }}" >> $GITHUB_ENV

      - name: set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 21

      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: false

      - name: Install dependencies
        run: |
          rm -f Gemfile.lock
          gem install bundler -v '2.7.2'
          bundle _2.7.2_ install

      - run: brew install swiftlint

      - uses: gradle/actions/setup-gradle@v5
        with:
          cache-disabled: true

      - name: Firebase iOS - GoogleService-Info.plist file
        env:
          DATA: ${{ secrets.FIREBASE_IOS_GOOGLE_INFO }}
        run: echo $DATA | base64 -d > iosApp/iosApp/GoogleService-Info.plist

      - name: Create App Store Connect API Key
        run: |
          mkdir -p $HOME/private_keys
          echo "${{ secrets.APPSTORE_PRIVATE_KEY }}" > $HOME/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8
          echo "APP_STORE_CONNECT_API_KEY_PATH=$HOME/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8" >> $GITHUB_ENV

      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v6
        with:
          p12-file-base64: ${{ secrets.IOS_DIST_SIGNING_KEY_BASE64 }}
          p12-password: ${{ secrets.IOS_DIST_SIGNING_KEY_PASSWORD }}

      - name: Download Provisioning Profiles
        uses: Apple-Actions/download-provisioning-profiles@v5
        with:
          bundle-id: xyz.ksharma.krail
          profile-type: IOS_APP_STORE
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}

      - name: Verify Code Signing Setup
        run: |
          echo "=== Checking Keychains ==="
          security list-keychains
          echo "=== Checking Provisioning Profiles ==="
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/ || echo "No profiles found"
          echo "=== Checking Identities ==="
          security find-identity -v -p codesigning

      - name: Build iOS App for Release
        continue-on-error: false
        env:
          IOS_NSW_TRANSPORT_API_KEY: ${{ secrets.IOS_NSW_TRANSPORT_API_KEY }}
          APP_BUNDLE_ID: xyz.ksharma.krail
          PROVISIONING_PROFILE_NAME: ${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PATH: ${{ env.APP_STORE_CONNECT_API_KEY_PATH }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 6
        run: |
          cd iosApp
          bundle _2.7.2_ exec fastlane build_release

      - name: Upload to TestFlight
        continue-on-error: false
        env:
          APP_STORE_CONNECT_API_KEY_PATH: ${{ env.APP_STORE_CONNECT_API_KEY_PATH }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        run: |
          cd iosApp
          # Verify IPA exists before upload
          if [ ! -f build/*.ipa ]; then
            echo "Error: IPA file not found!"
            exit 1
          fi
          bundle _2.7.2_ exec fastlane upload_testflight

      - name: Upload IPA as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: iosApp/build/*.ipa
          retention-days: 30
          if-no-files-found: error

